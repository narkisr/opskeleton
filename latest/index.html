<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Ronen Narkis, &lt;narkisr@gmail.com&gt;">
<title>Opskeleton</title>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f0f0f0; }
.listingblock .pygments .tok-c { color: #60a0b0; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #007020; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #007020 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #007020; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #007020 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #902000 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #40a070 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #4070a0 } /* Literal.String */
.listingblock .pygments .tok-na { color: #4070a0 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #007020 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0e84b5; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #60add5 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #d55537; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #007020 } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #06287e } /* Name.Function */
.listingblock .pygments .tok-nl { color: #002070; font-weight: bold } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #062873; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #bb60d5 } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #007020; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #40a070 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #40a070 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #40a070 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #40a070 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #40a070 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #4070a0 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #4070a0 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #4070a0 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #4070a0 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #c65d09 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #235388 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #4070a0 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #517918 } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #bb60d5 } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #bb60d5 } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #bb60d5 } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #40a070 } /* Literal.Number.Integer.Long */
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Liberation+Mono:400|Roboto+Slab:400,700"/>
<link rel="stylesheet" href="https://www.niwi.nz/_assets/asciidoctor-styles/simple-red-titles/stylesheet.css"/>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Opskeleton</h1>
<div class="details">
<span id="author" class="author">Ronen Narkis, &lt;narkisr@gmail.com&gt;</span><br>
<span id="revdate">v0.9.2</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#usage">Usage</a>
<ul class="sectlevel2">
<li><a href="#installation">Installation</a></li>
<li><a href="#boxes">Boxes</a></li>
</ul>
</li>
<li><a href="#puppet">Puppet</a>
<ul class="sectlevel2">
<li><a href="#introduction-2">Introduction</a></li>
<li><a href="#structure">Structure</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#packaging">Packaging</a></li>
<li><a href="#updating">Updating</a></li>
<li><a href="#vagrant">Vagrant</a></li>
<li><a href="#docker">Docker</a></li>
<li><a href="#benchmarking">Benchmarking</a></li>
</ul>
</li>
<li><a href="#chef">Chef</a>
<ul class="sectlevel2">
<li><a href="#introduction-3">Introduction</a></li>
<li><a href="#structure-2">Structure</a></li>
<li><a href="#testing-2">Testing</a></li>
<li><a href="#packaging-2">Packaging</a></li>
<li><a href="#updating-2">Updating</a></li>
<li><a href="#vagrant-2">Vagrant</a></li>
</ul>
</li>
<li><a href="#deployment">Deployment</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction"><a class="link" href="#introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Opskelaton is an opinionated bootstrap tool for local Sandbox projects, it aims to solve the following common issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Developing Puppet/Chef modules/cookbooks on master machines which results with 'It works on my master/server' approach.</p>
</li>
<li>
<p>Large monolithic Puppet/Chef code bases, code isn&#8217;t modular or reusable.</p>
</li>
<li>
<p>Implicit/Missing dependencies including: Ruby version, OS, gems, modules/cookbooks.</p>
</li>
<li>
<p>Manual steps in setting up and maintaining such projects.</p>
</li>
<li>
<p>Non standard layout, projects missing README and LICENSE files, no clear separation between developed and dependant code.</p>
</li>
<li>
<p>Lacking development guidelines (for example extracting general modules and exporting them).</p>
</li>
<li>
<p>No continues build, linting and testing, provisioning code is second class citizen.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Opskeleton comes to solve these issues by introducing a decentralized development work flow with pre-defined layout, packaging and dependency management.</p>
</div>
<div class="paragraph">
<p>Currently Opskeleton supports Puppet and Chef, this guide is segmented to common functionality the respective separate sections for Puppet and Chef.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage"><a class="link" href="#usage">Usage</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="installation"><a class="link" href="#installation">Installation</a></h3>
<div class="paragraph">
<p>Perquisites (on Ubuntu):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vagrant 1.7.x</p>
</li>
<li>
<p>RVM</p>
</li>
<li>
<p>Ruby 2.1.x</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"> <span class="tok-nv">$ </span>rvm use system
 <span class="tok-nv">$ </span>sudo gem install opskeleton</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="boxes"><a class="link" href="#boxes">Boxes</a></h3>
<div class="paragraph">
<p>Opskeleton recommends the use of <a href="https://github.com/box-cutter">box-cutter</a> in order to create Vagrant boxes in a consistent manner (as no free hosting solution currently exist):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># make sure to have latest packer</span>
<span class="tok-nv">$ </span>packer version
Packer v0.6.0
<span class="tok-nv">$ </span>git clone git@github.com:box-cutter/ubuntu-vm.git
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>ubuntu-vm
<span class="tok-c"># Edit Makefile.local</span>
<span class="tok-nv">$ </span>cat Makefile.local
<span class="tok-c"># Makefile.local</span>
CM :<span class="tok-o">=</span> puppet
CM_VERSION :<span class="tok-o">=</span> 3.6.1
<span class="tok-nv">$ </span>make virtualbox/ubuntu1404</code></pre>
</div>
</div>
<div class="paragraph">
<p>A useful convention for Box names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">ubuntu-14.04_puppet-3.6.1 <span class="tok-o">([</span>os<span class="tok-o">]</span>-<span class="tok-o">[</span>version<span class="tok-o">]</span>_<span class="tok-o">[</span>provisioner<span class="tok-o">]</span>-<span class="tok-o">[</span>version<span class="tok-o">])</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="puppet"><a class="link" href="#puppet">Puppet</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction-2"><a class="link" href="#introduction-2">Introduction</a></h3>
<div class="paragraph">
<p>Opskeleton supports the creation of Puppet based projects supporting dependency management (using librarian-puppet), linting and testing.</p>
</div>
</div>
<div class="sect2">
<h3 id="structure"><a class="link" href="#structure">Structure</a></h3>
<div class="sect3">
<h4 id="layout"><a class="link" href="#layout">Layout</a></h4>
<div class="paragraph">
<p>Opskeleton generates the complete folder structure for projects:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/opskeleton/opskeleton/master/img/puppet-layout.png" alt="puppet-layout" width="30%"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="lifecycle"><a class="link" href="#lifecycle">Lifecycle</a></h4>
<div class="paragraph">
<p>Opskelaton defines a module life cycle:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Internal non reusable modules (usually specific to a client site) go under static-modules</p>
</li>
<li>
<p>If we create a general reusable module which is ready for prime time we pull out to a new git repository.</p>
</li>
<li>
<p>The extracted module is added back as a third party (using <a href="https://github.com/rodjek/librarian-puppet">librarian-puppet</a> module which resides under modules folder.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Life cycle scheme:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/opskeleton/opskeleton/master/img/puppet-cycle.png" alt="puppet-cycle" width="40%"></span></p>
</div>
<div class="paragraph">
<p>Creating new (static) modules is easy as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk module foo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each generated module will contain puppet-rspec with matching Rakefile.</p>
</div>
</div>
<div class="sect3">
<h4 id="pushing-changes"><a class="link" href="#pushing-changes">Pushing changes</a></h4>
<div class="paragraph">
<p>Making changes to third party modules is quite easy once librarian-puppet installed them locally (you can push only git based modules):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">forge</span> <span class="tok-s2">&quot;https://forgeapi.puppetlabs.com&quot;</span>

<span class="tok-n">mod</span> <span class="tok-s1">&#39;puppetlabs/stdlib&#39;</span>
<span class="tok-n">mod</span> <span class="tok-s1">&#39;puppetlabs/apt&#39;</span>

<span class="tok-n">mod</span> <span class="tok-s1">&#39;strings/artifactory&#39;</span><span class="tok-p">,</span>
   <span class="tok-ss">:git</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;git://github.com/pulling-strings/puppet-artifactory.git&#39;</span>

<span class="tok-n">mod</span> <span class="tok-s1">&#39;rip/module-data&#39;</span><span class="tok-p">,</span>
  <span class="tok-ss">:git</span> <span class="tok-o">=&gt;</span> <span class="tok-s1">&#39;git://github.com/ripienaar/puppet-module-data.git&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Its best practice to use git protocol (read only) which makes pushing changes from multiple modules a bit tedious, Opskeleton fixes that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># We hacked a number of submodules, now we commit</span>
<span class="tok-nv">$ </span>opsk commit
Listing changes <span class="tok-k">for</span> modules/artifactory:

changed files:

- metadata.json

added files:

untracked files:

Commit the changes under modules/artifactory? <span class="tok-o">(</span>y/n<span class="tok-o">)</span> y
Commit message:
This is a nice change</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running opsk commit will scan the modules folder for changed repositories asking the user for commit message.</p>
</div>
<div class="paragraph">
<p>Once commits are made we can push the changes, Opskeleton will add a writable repository from the read only origin url:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk push
Push modules/artifactory? <span class="tok-o">(</span>y/n<span class="tok-o">)</span> y
pushing modules/artifactory ..</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing"><a class="link" href="#testing">Testing</a></h3>
<div class="paragraph">
<p>Opskelaton supports two levels of testing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Static module testing that includes rspec and linting.</p>
</li>
<li>
<p>Integration testing using <a href="http://serverspec.org/">serverspec</a>and Vagrant.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># linting all static modules</span>
<span class="tok-nv">$ </span>rake lint
<span class="tok-c"># rspecing</span>
<span class="tok-nv">$ </span>rake modspec
<span class="tok-c"># running serverspec</span>
<span class="tok-nv">$ </span>rake spec</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="packaging"><a class="link" href="#packaging">Packaging</a></h3>
<div class="paragraph">
<p>Opskelaton fully supports deployment and portable execution of sandboxes on non Vagrant environments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk generate_puppet foo ubuntu-13.10
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>foo-sandbox
<span class="tok-c"># The package version file</span>
<span class="tok-nv">$ </span>cat opsk.yaml
---
  version: <span class="tok-s1">&#39;0.0.1&#39;</span>
  name: foo

<span class="tok-c"># post bundle and gem install ..</span>
<span class="tok-nv">$ </span>opsk package
      create  pkg/foo-sandbox-0.0.1
      create  pkg/foo-sandbox-0.0.1/scripts
      create  pkg/foo-sandbox-0.0.1/scripts/lookup.rb
       chmod  pkg/foo-sandbox-0.0.1/scripts/lookup.rb
      create  pkg/foo-sandbox-0.0.1/scripts/run.sh
       chmod  pkg/foo-sandbox-0.0.1/scripts/run.sh
      create  pkg/foo-sandbox-0.0.1/manifests/site.pp
       exist  pkg
<span class="tok-nv">$ </span>ls pkg
foo-sandbox-0.0.1  foo-sandbox-0.0.1.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>The packaging process creates a portable tar file that can be run on any machine with puppet installed via the bundled run.sh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>tar -xvzf foo-sandbox-0.0.1.tar.gz
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>foo-sandbox-0.0.1
<span class="tok-nv">$ </span>sudo ./run.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>An external node classifier based runner is also available under scripts/run.sh, this runner expects to get a &lt;hostname&gt;.yaml input file with the required node classes.</p>
</div>
</div>
<div class="sect2">
<h3 id="updating"><a class="link" href="#updating">Updating</a></h3>
<div class="paragraph">
<p>Keeping you box up to date with latest opsk version is easy, just re-generate it again and resolve conflicts by answering y/n:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># Moving to latest opsk</span>
<span class="tok-nv">$ </span>gem update opskeleton
<span class="tok-c"># foo box already exists</span>
<span class="tok-nv">$ </span>opsk generate foo &lt;vagrant-box&gt;
 exist  foo-sandbox
    conflict  foo-sandbox/Vagrantfile
Overwrite /home/ronen/code/foo-sandbox/Vagrantfile? <span class="tok-o">(</span>enter <span class="tok-s2">&quot;h&quot;</span> <span class="tok-k">for</span> <span class="tok-nb">help</span><span class="tok-o">)</span> <span class="tok-o">[</span>Ynaqdh<span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vagrant"><a class="link" href="#vagrant">Vagrant</a></h3>
<div class="paragraph">
<p>Opskeleton generates a Vagrant file with couple of enhancements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>VAGRANT_BRIDGE (default eth0) for setting up public bridge on the go.</p>
</li>
<li>
<p>PUPPET_ENV (default dev) for setting puppet environment.</p>
</li>
<li>
<p>Puppet options preset to match modules and hiera folders.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="docker"><a class="link" href="#docker">Docker</a></h3>
<div class="paragraph">
<p>The only assumption that Opskelaton makes is that the target host will have Pupppet installed, this enables us to create docker images from our sandboxes quite easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># creates dockerfiles/&lt;host&gt; and fig.yml</span>
<span class="tok-nv">$ </span>opsk dockerize
<span class="tok-nv">$ </span>opsk package
<span class="tok-c"># grabs the opsk tar file</span>
<span class="tok-nv">$ </span>sudo fig build</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarking"><a class="link" href="#benchmarking">Benchmarking</a></h3>
<div class="paragraph">
<p>Tracking the speed of our provisioning code is important for keeping a consistent level of service with the produced sandboxes, enabling benchmarking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk generate_puppet redis ubuntu-14.04 --bench-enable
<span class="tok-c"># install imagemagic before bundle install</span>
<span class="tok-nv">$ </span>sudo apt-get install imagemagick libmagickwand-dev
<span class="tok-nv">$ </span>rake serverspec:redis
<span class="tok-c"># with each run more result lines will be recorded</span>
<span class="tok-nv">$ </span>cat benchmark.json
<span class="tok-o">{</span><span class="tok-s2">&quot;total&quot;</span>:656,<span class="tok-s2">&quot;host&quot;</span>:<span class="tok-s2">&quot;redis&quot;</span>,<span class="tok-s2">&quot;revision&quot;</span>:<span class="tok-s2">&quot;5d03a41ade9fc3dd5296d4119ccb0b0ad8290b9e&quot;</span>,<span class="tok-s2">&quot;time&quot;</span>:<span class="tok-s2">&quot;2014-12-17 02:57:45 +0200&quot;</span><span class="tok-o">}</span>
<span class="tok-c"># add it to git for tracking</span>
<span class="tok-nv">$ </span>git add benchmark.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now after a number of runs we could plot and view the results of a single host or of all the hosts side by side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>rake plot:hosts plot:per_hosts
<span class="tok-c"># resulting png files</span>
<span class="tok-nv">$ </span>google-chrome plots</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chef"><a class="link" href="#chef">Chef</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction-3"><a class="link" href="#introduction-3">Introduction</a></h3>
<div class="paragraph">
<p>Opskelaton fully supports Chef based projects it offers similar features to the Puppet based sandboxes with additional support for roles, environments and cookbooks.</p>
</div>
<div class="paragraph">
<p>Creating out first sandbox</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk generate_chef redis ubuntu-14.04
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>redis-sandbox</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="structure-2"><a class="link" href="#structure-2">Structure</a></h3>
<div class="sect3">
<h4 id="layout-2"><a class="link" href="#layout-2">layout</a></h4>
<div class="paragraph">
<p>Opskelaton creates the complete folder structure fine tuned to match best practices:</p>
</div>
<div class="paragraph">
<p>Folder layout:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/opskeleton/opskeleton/master/img/chef-layout.png" alt="chef-layout" width="30%"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="lifecycle-2"><a class="link" href="#lifecycle-2">lifecycle</a></h4>
<div class="paragraph">
<p>Opskelaton defines a simple cookbook life cycle:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Internal non reusable cookbooks (usually specific to a client site) go under static-cookbooks</p>
</li>
<li>
<p>If we create a general reusable cookbook which is ready for prime time we pull out to a new git repository.</p>
</li>
<li>
<p>The extracted cookbook is added back as a third party (using [librarian-chef](<a href="https://github.com/applicationsonline/librarian-chef" class="bare">https://github.com/applicationsonline/librarian-chef</a>) thatd will place them under cookbooks folder).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Life cycle scheme:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://raw.githubusercontent.com/opskeleton/opskeleton/master/img/chef-cycle.png" alt="chef-cycle" width="40%"></span></p>
</div>
<div class="paragraph">
<p>Creating new cookbooks is easy as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk cookbook foo</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing-2"><a class="link" href="#testing-2">Testing</a></h3>
<div class="paragraph">
<p>Opskelaton supports testing/linting:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Static cookbook testing that includes rspec and food-critic. (TBD)</p>
</li>
<li>
<p>Integration testing using [serverspec](<a href="http://serverspec.org/" class="bare">http://serverspec.org/</a>) and Vagrant.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># running serverspec</span>
<span class="tok-nv">$ </span>rake spec</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="packaging-2"><a class="link" href="#packaging-2">Packaging</a></h3>
<div class="paragraph">
<p>Opskelaton fully supports deployment and portable execution of sandboxes on non Vagrant environments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk generate_chef foo ubuntu-14.04.
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>foo-sandbox
<span class="tok-c"># The package version file</span>
<span class="tok-nv">$ </span>cat opsk.yaml

---
  version: <span class="tok-s1">&#39;0.0.1&#39;</span>
  name: redis
  includes:
    - Cheffile
    - cookbooks
    - static-cookbooks
    - dna.json
    - environments
    - Gemfile
    - Gemfile.lock
    - opsk.yaml
    - roles
    - LICENSE-2.0.txt
    - run.sh
    - boot.sh
    - solo.rb

<span class="tok-c"># post bundle and gem install ..</span>
<span class="tok-nv">$ </span>opsk package
	create  pkg/foo-sandbox-0.0.1
	create  pkg/foo-sandbox-0.0.1/scripts
	create  pkg/foo-sandbox-0.0.1/scripts/lookup.rb
	 chmod  pkg/foo-sandbox-0.0.1/scripts/lookup.rb
	create  pkg/foo-sandbox-0.0.1/scripts/run.sh
	 chmod  pkg/foo-sandbox-0.0.1/scripts/run.sh
	 exist  pkg
<span class="tok-nv">$ </span>ls pkg
foo-sandbox-0.0.1  foo-sandbox-0.0.1.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>The packaging process creates a portable tar file that can be run on any machine with chef-solo installed via the bundled run.sh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>tar -xvzf foo-sandbox-0.0.1.tar.gz
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>foo-sandbox-0.0.1
<span class="tok-c"># expects to get the chef environment</span>
<span class="tok-nv">$ </span>sudo ./run.sh dev</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="updating-2"><a class="link" href="#updating-2">Updating</a></h3>
<div class="paragraph">
<p>Keeping you box up to date with latest opsk version is easy, just re-generate it again and resolve conflicts by answering y/n:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># Moving to latest opsk</span>
<span class="tok-nv">$ </span>gem update opskeleton
<span class="tok-c"># foo box already exists</span>
<span class="tok-nv">$ </span>opsk generate_chef foo &lt;vagrant-box&gt;
 exist  foo-sandbox
    conflict  foo-sandbox/Vagrantfile
Overwrite /home/ronen/code/foo-sandbox/Vagrantfile? <span class="tok-o">(</span>enter <span class="tok-s2">&quot;h&quot;</span> <span class="tok-k">for</span> <span class="tok-nb">help</span><span class="tok-o">)</span> <span class="tok-o">[</span>Ynaqdh<span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vagrant-2"><a class="link" href="#vagrant-2">Vagrant</a></h3>
<div class="paragraph">
<p>Opskeleton generates a Vagrant file with couple of enhancements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CHEF_ENV (default dev) for setting chef environment.</p>
</li>
<li>
<p>Default role (sandbox name) created under roles/{type}.rb</p>
</li>
<li>
<p>static-cookbooks/cookbooks roles/environments folders are set.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployment"><a class="link" href="#deployment">Deployment</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The packaged tar files can be consumed using any tool and protocol (http, s3 etc),  opsk has built in support for deploying public sandboxes into:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bintray (make sure to  <a href="https://github.com/narkisr/bintray-deploy#usage">configure</a> the bintray API key):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk package
<span class="tok-nv">$ </span>opsk deploy_bintray &lt;bintray-repo&gt;
   deployed foo-sandbox-0.0.1.tar.gz to http://dl.bintray.com/narkisr/&lt;bintray-repo&gt;/foo-sandbox-0.0.1.tar.gz</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>S3 (Make sure to configure s3 section under ~/.configuration.rb):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk package
<span class="tok-nv">$ </span>opsk deploy_s3 &lt;bucket&gt; &lt;path&gt;
   deployed foo-sandbox-0.0.1.tar.gz to opsk-boxes/foo/foo-sandbox-0.0.1.tar.gz</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-no">Configuration</span><span class="tok-o">.</span><span class="tok-n">for</span><span class="tok-p">(</span><span class="tok-s1">&#39;s3&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-n">access_key</span> <span class="tok-s1">&#39;&#39;</span>
  <span class="tok-n">secret_key</span> <span class="tok-s1">&#39;&#39;</span>
  <span class="tok-n">region</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Scp (Make sure to configure scp section under ~/.configuration.rb):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>opsk package
<span class="tok-nv">$ </span>opsk deploy_scp bar
   deployed foo-sandbox-0.0.1.tar.gz to foo@opsk-boxes:/var/boxes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-no">Configuration</span><span class="tok-o">.</span><span class="tok-n">for</span><span class="tok-p">(</span><span class="tok-s1">&#39;scp&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-n">bar</span> <span class="tok-p">{</span>
   <span class="tok-n">host</span> <span class="tok-s1">&#39;opsk-boxes&#39;</span>
   <span class="tok-n">user</span> <span class="tok-s1">&#39;foo&#39;</span>
   <span class="tok-n">dest</span> <span class="tok-s1">&#39;/var/boxes&#39;</span>
   <span class="tok-c1"># optional</span>
   <span class="tok-n">port</span> <span class="tok-mi">2222</span>
 <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-07-13 16:10:22 IDT
</div>
</div>
</body>
</html>